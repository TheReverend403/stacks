services:
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    init: true
    user: ${PUID:-1000}:${PGID:-1000}
    depends_on:
      - influxdb
    env_file: .env
    environment:
      GF_SERVER_DOMAIN: ${GF_SERVER_DOMAIN:?}
      GF_SERVER_ROOT_URL: ${GF_SERVER_ROOT_URL:?}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${BASE_DIR:?}/data/grafana:/var/lib/grafana
      - ${BASE_DIR:?}/config/grafana:/etc/grafana
    networks:
      - monitoring
      - caddy
    deploy:
      resources:
        limits:
          cpus: ${GRAFANA_CPU_LIMIT:-${CPU_LIMIT:-0}}
          memory: ${GRAFANA_MEM_LIMIT:-${MEM_LIMIT:-0}}

  influxdb:
    image: influxdb:latest
    container_name: influxdb
    restart: unless-stopped
    init: true
    user: ${PUID:-1000}:${PGID:-1000}
    env_file: .env
    environment:
      INFLUX_TOKEN: ${INFLUX_TOKEN:?}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${BASE_DIR:?}/data/influxdb:/var/lib/influxdb2
      - ${BASE_DIR:?}/config/influxdb:/etc/influxdb2
    networks:
      - monitoring
      - caddy
    deploy:
      resources:
        limits:
          cpus: ${INFLUX_CPU_LIMIT:-${CPU_LIMIT:-0}}
          memory: ${INFLUX_MEM_LIMIT:-${MEM_LIMIT:-0}}

networks:
  monitoring:
    name: monitoring
  caddy:
    external: true
